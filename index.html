<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title></title>
  <script type="text/javascript" src="js/close-pixelate.js"></script>
  <link rel="stylesheet" type="text/css" href="js/pixelate.min.css">
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.5/dat.gui.min.js"></script>
  <script src="js/jquery.min.js"></script>
  <script type="text/javascript" src="js/pixelate.min.js"></script>
  <script type="text/javascript" src="js/chroma.min.js"></script>
  <script src="js/jQueryEmoji.min.js"></script>
  <script type="text/javascript" src="js/color.js"></script>
  <script type="text/javascript" src="js/emoji.js"></script>
  <script type="text/javascript" src="js/emojione.js"></script>
  <script type="text/javascript" src="js/emojiController.js"></script>
</head>

<body>
  <img id="portrait-image" src="img/portrait.jpg" />
  <button id="pixelate">Pixelate Emojis</button>
  <p id="placeholder"></p>
  <!-- <button id="btndownload">Download</button> -->
  <!-- <a id="download" download onclick="download_img()">Download to myImage.png</a> -->
  <!-- <img id="sprite" src="img/emojis.png" /> -->
  <canvas id="sprite_canvas" width=1008 height="1008"></canvas>
  <!-- <img src="img/emojis.png" /> -->
  <canvas id="emojis" width=1680 height="1680"></canvas>
  <p id="all"></p>
</body>
<style type="text/css">
#emojis {
  display: none;
}

p {
  line-height: 22px;
}
</style>
<script type="text/javascript">
var img = document.getElementById('portrait-image');
console.log('image width: ', img.width)
var closepixel; //closepixel object
var pixelData; //GUI controller


//emoji to text
// emojiList.forEach((e, i) => {
//   let p = document.getElementById("all")
//   p.innerHTML += e
//   if (i % 42 == 41) {
//     p.innerHTML += '<br>'
//   }

// })



function initPixel() {
  let res = img.width / pixelData.column

  closepixel = img.closePixelate([
    { resolution: Math.floor(res / 2) * 2 },
  ]);

};

var imagePixel = function() {
  // Number of Pixels per line
  this.column = 17;
  // Resolution: Every few pixels
  this.resolution = Math.floor(img.width / this.column / 2) * 2;
}

function chunk(array, size) {
  const chunked_arr = [];
  for (let i = 0; i < array.length; i++) {
    const last = chunked_arr[chunked_arr.length - 1];
    if (!last || last.length === size) {
      chunked_arr.push([array[i]]);
    } else {
      last.push(array[i]);
    }
  }
  return chunked_arr;
}


function getPixelArray(canvas, cols, res, size) {
  let ctx = canvas.getContext('2d');
  let pixelArray = [];


  for (let j = 0; j < cols; j++) {

    pixelArray.push([])
    for (let i = 0; i < cols; i++) {

      var pixel = ctx.getImageData(i * res, j * res, size, size);
      var data = pixel.data;
      // console.log(data[0], data[1], data[2], data[3])
      var rgba = 'rgba(' + data[0] + ', ' + data[1] +
        ', ' + data[2] + ', ' + (data[3] / 255) + ')';

      // pixelArray[pixelArray.length - 1].push(rgba)
      pixelArray[pixelArray.length - 1].push(chroma(rgba));
    }
  }
  return pixelArray;

}

function initGUI() {
  pixelData = new imagePixel();
  var gui = new dat.GUI();
  gui.add(pixelData, 'column', 1, 48).step(1).onChange(newColumn => {

    pixelData.resolution = Math.floor(img.width / pixelData.column / 2) * 2;

    // re-render the closePixelation
    closepixel.render([{ resolution: pixelData.resolution }])

  }).onFinishChange(newColumn => {

    // updateEmojiText()
  });

}



function getEmojiIndex(canvas, col) {
  let pixels = getPixelArray(canvas, col, Math.floor(canvas.width / col / 2) * 2, 1);
  // console.log("pixels", pixels)

  var result = []
  for (let j = 0; j < pixels.length; j++) {
    result.push([])
    for (let i = 0; i < pixels[0].length; i++) {
      let indexs = findEmoji(pixels[j][i], emojiColors)
      // let indexs = emojiController.getEmoji(pixels[j][i])
      result[result.length - 1].push(indexs)
    }
  }
  return result
}

//Update Emoji Text
function updateEmojiText() {
  let canvas = document.getElementById("portrait-image");
  let es = getEmojiIndex(canvas, pixelData.column)
  var p = document.getElementById("placeholder");
  p.innerHTML = '';
  es.forEach(row => {
    let a = row.map(e => emojiList[e[0] * 42 + e[1]])

    let s = a.join("")
    s = s.replace(/\s/g, '')
    // console.log(s)

    p.innerHTML += s
    p.innerHTML += '<br>'
  })
}


function initSprite() {
  let p = document.getElementById("all")
  let canvas = document.getElementById('sprite_canvas');
  emojiController.toText(p)
  emojiController.toCanvas('#all', canvas);

  // emojiController.toPixel(canvas);
  let button = document.getElementById("pixelate");
  button.onclick = () => {
    // After all image is loaded
    emojiController.toPixelArray(canvas);
    emojiController.toPixel(canvas)

    let portrait = document.getElementById("portrait-image");

    let pixels = getPixelArray(portrait, 17, Math.floor(portrait.width / pixelData.column / 2) * 2, 1);
    // console.log("pixels", pixels)

    var result = []
    for (let j = 0; j < pixels.length; j++) {
      result.push([])
      for (let i = 0; i < pixels[0].length; i++) {
        let indexs = emojiController.getEmoji(pixels[j][i])
        // let indexs = emojiController.getEmoji(pixels[j][i])
        result[result.length - 1].push(indexs)
      }
    }

    // console.log(result)
    // // let es = getEmojiIndex(canvas, pixelData.column)
   
    var placeholder = document.getElementById("placeholder");
    placeholder.innerHTML = '';
    result.forEach(row => {
      let a = row.map(e => emojiController.list[e])

      let s = a.join("")
      s = s.replace(/\s/g, '')
      // console.log(a)

      placeholder.innerHTML += s
      placeholder.innerHTML += '<br>'
    })

  }

}

function init() {
  initSprite()

  initGUI()
  initPixel()
  // updateEmojiText()

}


window.addEventListener('load', init, false);

var lists = [];

function buildSprite() {
  function emojify() {
    $('p#placeholder').Emoji({
      path: 'img/apple/',
      // path: 'http://rodrigopolo.com/files/emojilist/img/apple/',
      class: 'emoji',
      ext: 'png'
    })

    var imgs = document.querySelectorAll('p#placeholder > img')
    while (imgs == null) {
      imgs = document.querySelectorAll('p#placeholder > img')
    }
  }

  let canvas = document.getElementById('emojis');
  let ctx = canvas.getContext('2d');

  $('p#placeholder').html(emojiList)

  emojify()

  //Draw all the emoji to canvas
  let w = 42;
  let h = 42;
  var imgs = document.querySelectorAll('p#placeholder > img')

  for (let j = 0; j < h; j++) {
    for (let i = 0; i < w; i++) {
      let index = j * w + i;
      if (index >= 1761) { return }
      let img = imgs[index];
      img.onload = function() {
        ctx.drawImage(img, i * 40, j * 40);
      };

    }
  }

}
// buildSprite()

function findEmoji(color, colorList) {
  // Compute a Matrix of distance to the color
  let distances = []
  for (let row = 0; row < colorList.length; row++) {
    distances.push(colorList[row].map((x, col) =>
      chroma.distance(color, colorList[row][col])
      // , 'rgb'
    ));
  }
  // Find index of the min of the Matrix
  var minPerRow = distances.map(rowElements => Math.min(...rowElements))
  let rowNum = minPerRow.indexOf(Math.min(...minPerRow))
  let colNum = distances[rowNum].indexOf(minPerRow[rowNum])
  return [rowNum, colNum]
}


// var spriteImg = document.getElementById("sprite");
// spriteImg.onload = () => {

//   var canvas = document.getElementById("sprite_canvas");
//   canvas.setAttribute('width', spriteImg.width)
//   canvas.setAttribute('height', spriteImg.height)
//   var ctx = canvas.getContext('2d')
//   ctx.drawImage(spriteImg, 0, 0, spriteImg.width, spriteImg.width)

//   let pixelArray = [];
//   let res = Math.floor(canvas.width / 42)
//   console.log('res', res)

//   for (let j = 0; j < 42; j++) {
//     let y = j * res;
//     pixelArray.push([])
//     for (let i = 0; i < 42; i++) {
//       // For each emoji
//       let x = i * res;
//       var pixel = ctx.getImageData(x + 2, y + 2, res - 4, res - 4);
//       var data = pixel.data;

//       data = chunk(data, 4)

//       //get average color of the size
//       data = data
//         .filter(color => color[3] > 60)
//         .map(color =>
//           chroma(color[0], color[1], color[2]).alpha(color[3] / 255).css()
//         )

//       var average = chroma.average(data);
//       pixelArray[pixelArray.length - 1].push(average.css())

//     }
//   }

//   ctx.clearRect(0, 0, canvas.width, canvas.height)

//   pixelArray.forEach((emojiRow, j) => {
//     emojiRow.forEach((color, i) => {
//       ctx.beginPath();
//       ctx.rect(i * res + 1, j * res + 1, res - 2, res - 2);
//       ctx.fillStyle = color;
//       ctx.fill();
//     })
//   })

// }
</script>

</html>