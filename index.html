<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title></title>
  <script type="text/javascript" src="js/close-pixelate.js"></script>
  <link rel="stylesheet" type="text/css" href="js/pixelate.min.css">
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.5/dat.gui.min.js"></script>
  <script src="js/jquery.min.js"></script>
  <script type="text/javascript" src="js/pixelate.min.js"></script>
  <script type="text/javascript" src="js/chroma.min.js"></script>
  <script src="js/jQueryEmoji.min.js"></script>
  <script type="text/javascript" src="js/color.js"></script>
  <script type="text/javascript" src="js/emoji.js"></script>
  <script type="text/javascript" src="js/emojione.js"></script>
  <script type="text/javascript" src="js/emojiController.js"></script>
</head>

<body>
  <img id="portrait-image" src="img/portrait.jpg" />
  <!-- <img id="portrait-image" src="img/26ab.png" /> -->
  <button id="pixelate">Pixelate Emojis</button>
  <p id="placeholder" style="letterSpacing:14px"></p>
  <!-- <button id="btndownload">Download</button> -->
  <!-- <a id="download" download onclick="download_img()">Download to myImage.png</a> -->
  <!-- <img id="sprite" src="img/emojis.png" /> -->
  <canvas id="sprite_canvas" width=1008 height="1008"></canvas>
  <!-- <img src="img/emojis.png" /> -->
  <canvas id="emojis" width=1680 height="1680"></canvas>
  <p id="all"></p>
</body>
<style type="text/css">
#emojis {
  display: none;
}

p {
  line-height: 22px;
}
</style>
<script type="text/javascript">
var img = document.getElementById('portrait-image');
console.log('image width: ', img.width)
var closepixel; //closepixel object
var pixelData; //GUI controller

const keywords = {
 // 9acd32' aliceblue: '#f0f8ff',
 //  antiquewhite: '#faebd7',
  aqua: '#00ffff',
 //  aquamarine: '#7fffd4',
 //  azure: '#f0ffff',
 //  beige: '#f5f5dc',
  bisque: '#ffe4c4',
  black: '#000000',
 //  blanchedalmond: '#ffebcd',
  blue: '#0000ff',
 //  blueviolet: '#8a2be2',
 //  brown: '#a52a2a',
 //  burlywood: '#deb887',
 //  cadetblue: '#5f9ea0',
 //  chartreuse: '#7fff00',
 //  chocolate: '#d2691e',
 //  coral: '#ff7f50',
 //  cornflower: '#6495ed',
 //  cornflowerblue: '#6495ed',
 //  cornsilk: '#fff8dc',
 //  crimson: '#dc143c',
 //  cyan: '#00ffff',
 //  darkblue: '#00008b',
 //  darkcyan: '#008b8b',
 //  darkgoldenrod: '#b8860b',
 //  darkgray: '#a9a9a9',
 //  darkgreen: '#006400',
 //  darkkhaki: '#bdb76b',
 //  darkmagenta: '#8b008b',
 //  darkolivegreen: '#556b2f',
 //  darkorange: '#ff8c00',
 //  darkorchid: '#9932cc',
 //  darkred: '#8b0000',
 //  darksalmon: '#e9967a',
 //  darkseagreen: '#8fbc8f',
 //  darkslateblue: '#483d8b',
 //  darkturquoise: '#00ced1',
 //  darkviolet: '#9400d3',
 //  deeppink: '#ff1493',
 //  deepskyblue: '#00bfff',
 //  dimgray: '#696969',
 //  dodgerblue: '#1e90ff',
 //  firebrick: '#b22222',
 //  floralwhite: '#fffaf0',
 //  forestgreen: '#228b22',
  fuchsia: '#ff00ff',
 //  gainsboro: '#dcdcdc',
 //  ghostwhite: '#f8f8ff',
 //  gold: '#ffd700',
 //  goldenrod: '#daa520',
  gray: '#808080',
  green: '#008000',
 //  greenyellow: '#adff2f',
 //  honeydew: '#f0fff0',
 //  hotpink: '#ff69b4',
 //  indianred: '#cd5c5c',
 //  indigo: '#4b0082',
 //  ivory: '#fffff0',
 //  khaki: '#f0e68c',
 //  laserlemon: '#ffff54',
 //  lavender: '#e6e6fa',
 //  lavenderblush: '#fff0f5',
 //  lawngreen: '#7cfc00',
 //  lemonchiffon: '#fffacd',
 //  lightblue: '#add8e6',
 //  lightcoral: '#f08080',
 //  lightcyan: '#e0ffff',
 //  lightgoldenrod: '#fafad2',
 //  lightgoldenrodyellow: '#fafad2',
 //  lightgray: '#d3d3d3',
 //  lightgreen: '#90ee90',
 //  lightpink: '#ffb6c1',
 //  lightsalmon: '#ffa07a',
 //  lightseagreen: '#20b2aa',
 //  lightskyblue: '#87cefa',
 //  lightslategray: '#778899',
 //  lightsteelblue: '#b0c4de',
 //  lightyellow: '#ffffe0',
  lime: '#00ff00',
 //  limegreen: '#32cd32',
 //  linen: '#faf0e6',
 //  magenta: '#ff00ff',
 //  maroon: '#800000',
 //  maroon2: '#7f0000',
 //  maroon3: '#b03060',
 //  mediumaquamarine: '#66cdaa',
 //  mediumblue: '#0000cd',
 //  mediumorchid: '#ba55d3',
 //  mediumpurple: '#9370db',
 //  mediumseagreen: '#3cb371',
 //  mediumslateblue: '#7b68ee',
 //  mediumspringgreen: '#00fa9a',
 //  mediumturquoise: '#48d1cc',
 //  mediumvioletred: '#c71585',
 //  midnightblue: '#191970',
 //  mintcream: '#f5fffa',
 //  mistyrose: '#ffe4e1',
 //  moccasin: '#ffe4b5',
 //  navajowhite: '#ffdead',
 //  navy: '#000080',
 //  oldlace: '#fdf5e6',
 //  olive: '#808000',
 //  olivedrab: '#6b8e23',
  orange: '#ffa500',
 //  orangered: '#ff4500',
 //  orchid: '#da70d6',
 //  palegoldenrod: '#eee8aa',
 //  palegreen: '#98fb98',
 //  paleturquoise: '#afeeee',
 //  palevioletred: '#db7093',
 //  papayawhip: '#ffefd5',
 //  peachpuff: '#ffdab9',
 //  peru: '#cd853f',
  pink: '#ffc0cb',
 //  plum: '#dda0dd',
 //  powderblue: '#b0e0e6',
  purple: '#800080',
 //  purple2: '#7f007f',
 //  purple3: '#a020f0',
 //  rebeccapurple: '#663399',
  red: '#ff0000',
 //  rosybrown: '#bc8f8f',
 //  royalblue: '#4169e1',
 //  saddlebrown: '#8b4513',
 //  salmon: '#fa8072',
 //  sandybrown: '#f4a460',
 //  seagreen: '#2e8b57',
 //  seashell: '#fff5ee',
 //  sienna: '#a0522d',
  silver: '#c0c0c0',
 //  skyblue: '#87ceeb',
 //  slateblue: '#6a5acd',
 //  slategray: '#708090',
 //  snow: '#fffafa',
 //  springgreen: '#00ff7f',
 //  steelblue: '#4682b4',
 //  tan: '#d2b48c',
 //  teal: '#008080',
 //  thistle: '#d8bfd8',
 //  tomato: '#ff6347',
 //  turquoise: '#40e0d0',
 //  violet: '#ee82ee',
 //  wheat: '#f5deb3',
  white: '#ffffff',
 //  whitesmoke: '#f5f5f5',
  yellow: '#ffff00'
}




function initPixel() {
  let res = img.width / pixelData.column

  closepixel = img.closePixelate([
    { resolution: Math.floor(res / 2) * 2 },
  ]);

};

var imagePixel = function() {
  // Number of Pixels per line
  this.column = 17;
  // Resolution: Every few pixels
  this.resolution = Math.floor(img.width / this.column / 2) * 2;
}

function chunk(array, size) {
  const chunked_arr = [];
  for (let i = 0; i < array.length; i++) {
    const last = chunked_arr[chunked_arr.length - 1];
    if (!last || last.length === size) {
      chunked_arr.push([array[i]]);
    } else {
      last.push(array[i]);
    }
  }
  return chunked_arr;
}


function getPixelArray(canvas, cols, res, size) {
  let ctx = canvas.getContext('2d');
  let pixelArray = [];


  for (let j = 0; j < cols; j++) {

    pixelArray.push([])
    for (let i = 0; i < cols; i++) {

      var pixel = ctx.getImageData(i * res, j * res, size, size);
      var data = pixel.data;
      data = chunk(data, 4)
      //get average color of the size
      data = data
        .map(color =>
          chroma(color[0], color[1], color[2]).css() //
        )

      var average = chroma.average(data);
      // pixelArray.push(average);
      pixelArray[pixelArray.length - 1].push(average);
    }
  }
  return pixelArray;

}

function initGUI() {
  pixelData = new imagePixel();
  var gui = new dat.GUI();
  gui.add(pixelData, 'column', 1, 48).step(1).onChange(newColumn => {

    pixelData.resolution = Math.floor(img.width / pixelData.column / 2) * 2;

    // re-render the closePixelation
    closepixel.render([{ resolution: pixelData.resolution }])

  }).onFinishChange(newColumn => {

  });

}




function initSprite() {
  let p = document.getElementById("all")
  let canvas = document.getElementById('sprite_canvas');
  emojiController.toText(p)
  emojiController.toCanvas('#all', canvas);


}

function init() {
  initSprite()

  initGUI()
  initPixel()

}




document.getElementById("pixelate").onclick = () => {



  let canvas = document.getElementById('sprite_canvas');
  // After all image is loaded
  emojiController.toPixelArray(canvas);
  // emojiController.pixelArray = Object.keys(keywords);
  emojiController.toPixel(canvas)


  // console.log("emojiarray", emojiController.pixelArray)
  let portrait = document.getElementById("portrait-image");

  let pixels = getPixelArray(portrait, 17, Math.floor(portrait.width / pixelData.column / 2) * 2, 1);
  // console.log("pixels", pixels)



  var result = []
  for (let j = 0; j < pixels.length; j++) {
    result.push([])
    for (let i = 0; i < pixels[0].length; i++) {
      let indexs = emojiController.getEmoji(pixels[j][i])
      // console.log(`distances:"${pixels[j][i]}","${emojiController.pixelArray[indexs]}"`)
      // let indexs = emojiController.getEmoji(pixels[j][i])
      result[result.length - 1].push(indexs)
    }
  }

  // console.log(result)
  // // let es = getEmojiIndex(canvas, pixelData.column)

  var placeholder = document.getElementById("placeholder");
  placeholder.innerHTML = '';
  result.forEach(row => {
    let a = row.map(e => emojiController.list[e])

    let s = a.join("")
    s = s.replace(/\s/g, '')
    // console.log(a)

    placeholder.innerHTML += s
    placeholder.innerHTML += '<br>'
  })




  // Object.keys(keywords).forEach(colorname => {
  //   let index = emojiController.getEmoji(keywords[colorname]);
  //   console.log(`${colorname}:["${keywords[colorname]}","${emojiController.list[index]}"]`)
  // })


}


window.addEventListener('load', init, false);

var lists = [];
</script>

</html>